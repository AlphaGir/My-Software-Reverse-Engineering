# 虚表和虚函数以及纯虚函数的逆向分析

## 1.环境准备

1. 调试器x64dbg
2. ide VS2019
3. 系统 win10

## 2.正向代码

让我们先来看一下正向代码，本次实验围绕该正向代码展开：

```c++
#include<cstdio>
class A {
public:
	int a=1, b=2;
	virtual void printA() {
		printf("A\n");
	}
	virtual void printB() = 0;
};

class B :public A {
public:
	int a=3, b=4;
	void printB() {
		printf("B\n");
	}
};

int main() {
	B* b =new B();
	b->printA();
	b->printB();
	return 0;
}
```

## 3.逆向分析

### 3.1寻找入口点

[![8wwPfA.png](https://s1.ax1x.com/2020/03/18/8wwPfA.png)](https://imgchr.com/i/8wwPfA)
[![8wwCYd.png](https://s1.ax1x.com/2020/03/18/8wwCYd.png)](https://imgchr.com/i/8wwCYd)
[![8wwSTe.png](https://s1.ax1x.com/2020/03/18/8wwSTe.png)](https://imgchr.com/i/8wwSTe)

### 3.2分析

#### 3.2.1.new

[![8w6V8e.png](https://s1.ax1x.com/2020/03/18/8w6V8e.png)](https://imgchr.com/i/8w6V8e)
[![8w6ECD.png](https://s1.ax1x.com/2020/03/18/8w6ECD.png)](https://imgchr.com/i/8w6ECD)

首先开辟局部变量空间，然后调用new函数在堆上分配对象的空间返回值存放在eax中，该地址下的内存空间值为0xCD，大小为5个双字。先给部分分析结果：

| 偏移 | 内容               |
| ---- | ------------------ |
| 0x0  | 虚表地址           |
| 0x4  | 父类第一个数据成员 |
| 0x8  | 父类第二个数据成员 |
| 0xC  | 子类第一个数据成员 |
| 0x10 | 子类第二个数据成员 |

#### 3.2.2 memset

![8w6ZgH.png](https://s1.ax1x.com/2020/03/18/8w6ZgH.png)

![8w6k4O.png](https://s1.ax1x.com/2020/03/18/8w6k4O.png)

调用memset对对象空间初始化为0x0。

#### 3.2.3 构造函数

![8w6evd.png](https://s1.ax1x.com/2020/03/18/8w6evd.png)

![8w6nKA.png](https://s1.ax1x.com/2020/03/18/8w6nKA.png)

![8w6uDI.png](https://s1.ax1x.com/2020/03/18/8w6uDI.png)

初始化后，调用子类构造函数，子类构造函数里面又调用了父类的构造函数，从而进行全部的初始化。返回值为对象的地址。

#### 3.2.4 虚函数和纯虚函数的调用

如图：

![8w6QVP.png](https://s1.ax1x.com/2020/03/18/8w6QVP.png)

![8w6lUf.png](https://s1.ax1x.com/2020/03/18/8w6lUf.png)

通过二次寻址，由对象地址取出首个4字节值为虚表数组的地址，再进行寻址，得到虚函数和纯虚函数的地址，分别调用。

内存布局：

| 偏移 | 内容           |
| ---- | -------------- |
| 0x0  | 父类虚函数地址 |
| 0x4  | 纯虚函数地址   |

## 4.总结

虚表和虚函数以及纯虚函数分析总结：
1.对象变量首个4字节存放虚表地址
2.局部变量分配基类在子类之前
3.纯虚函数和虚函数在同一张虚表里面（此代码得出的猜想）
4.虚函数在纯虚函数之前（此代码得出的猜想）

class子类的构造过程
1.new分配空间，返回对象地址，之后memset初始化对象
2.利用此地址，调用构造函数默认的构造函数所有数据成员赋值
3.再对部分或者全部数据成员赋值
4.通过虚表调用虚函数和纯虚函数